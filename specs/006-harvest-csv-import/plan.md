# Implementation Plan: Harvest CSV Import

**Branch**: `006-harvest-csv-import` | **Date**: 2026-02-25 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/006-harvest-csv-import/spec.md`

---

## Summary

Allow authenticated users to bulk-import harvest records via CSV. Users download
a pre-formatted template, fill it in offline, and upload it. The backend parses
and validates each row, performs case-insensitive plant name matching, and
returns a preview. For unmatched plant names the frontend presents the closest
fuzzy suggestion and lets the user confirm or override before the final
bulk-create call writes the records to the database.

**New dependency**: `csv-parse` v5 (backend only — CJS compatible, native ESM,
best per-row error recovery). **No new dependency** for fuzzy matching — inline
15-line Levenshtein function.

---

## Technical Context

**Language/Version**: Node.js 22 (backend CJS) / React 19 (frontend ESM)
**Primary Dependencies**: Express 5, Mongoose 9, multer (existing), csv-parse v5 (new — backend only)
**Storage**: MongoDB 7 — no new collections; existing `Harvest` model covers all fields
**Testing**: Jest 29 + Supertest + `mongodb-memory-server` (backend)
**Target Platform**: Linux/Docker, web browser
**Project Type**: Web application (existing `backend/` / `frontend/` split)
**Performance Goals**: Parse a 500-row CSV and return the preview response in <2 seconds
**Constraints**: File size limit ≤ 1 MB (configurable via multer); max rows enforced at route level (500)
**Scale/Scope**: Per-user import; plant library ≤ 200 items

---

## Constitution Check

### Pre-Design Gate

| Principle | Status | Notes |
|---|---|---|
| I. Layered Separation | ✅ Pass | CSV parsing, validation, plant matching, and harvest creation all live in the Express backend. Frontend only calls the API and renders results. |
| II. REST-First API Design | ✅ Pass | Three new endpoints: `GET /api/harvests/template`, `POST /api/harvests/import`, `POST /api/harvests/bulk`. All noun-based paths, correct verbs, direct response bodies (no wrapper envelope). |
| III. Permission-Gated Multi-Tenancy | ✅ Pass | All three routes use `requireAuth`. Plant lookup scoped to `userId` (system plants + user's own custom plants). |
| IV. Schema-Validated Data Integrity | ✅ Pass | No new Mongoose model needed. Existing `Harvest` model validates all fields. Route handlers validate required fields before any DB operation. |
| V. Server State via React Query | ✅ Pass | `useMutation` for upload and bulk-create. `queryClient.invalidateQueries(['harvests'])` on success. Import preview state held in `useState` (local UI state, not server state). |
| VI. Test-Before-Deploy | ✅ Pass | New Jest tests required for all three endpoints (happy path, bad file, missing columns, permission check). |
| VII. Simplicity & YAGNI | ✅ Pass | No new service layer. Inline Levenshtein (no dependency). `fuzzyMatch.js` utility is called in one place; not extracted as a shared helper unless reused. |
| VIII. Consistent Naming | ✅ Pass | `handleImportUpload`, `useHarvestImport`, `HarvestImportModal`, `PlantMatchResolver`, camelCase fields throughout. |

No violations — Complexity Tracking table not required.

### Post-Design Re-check

All principles hold after the data model and API contracts were defined. No new
violations introduced by the design.

---

## Project Structure

### Documentation (this feature)

```text
specs/006-harvest-csv-import/
├── plan.md              ← this file
├── research.md          ← Phase 0 output
├── data-model.md        ← Phase 1 output
├── quickstart.md        ← Phase 1 output
├── contracts/
│   └── api.md           ← Phase 1 output
└── tasks.md             ← Phase 2 output (generated by /speckit.tasks)
```

### Source Code

```text
backend/
├── src/
│   ├── routes/
│   │   └── harvests.js          EXTEND — add template, import, bulk endpoints
│   └── utils/
│       └── fuzzyMatch.js        NEW — inline Levenshtein helper
└── src/__tests__/
    └── harvestImport.test.js    NEW — Jest tests for the three new endpoints

frontend/
└── src/
    ├── pages/
    │   └── Harvests.jsx         EXTEND — add "Download template" + "Import CSV" buttons
    └── components/
        ├── HarvestImportModal.jsx    NEW — file upload + preview table + confirm/cancel
        └── PlantMatchResolver.jsx   NEW — resolution UI for each unmatched row
```

**Structure Decision**: Web application (Option 2). Extends the existing
`backend/src/routes/harvests.js` router; adds a utility module and two new
frontend components.

---

## Implementation Notes

### Backend

#### `GET /api/harvests/template`
- Returns a static CSV string with header row + one example row
- `Content-Type: text/csv`, `Content-Disposition: attachment; filename="harvest-template.csv"`

#### `POST /api/harvests/import`
- `multer({ storage: memoryStorage(), limits: { fileSize: 1_000_000 } })` middleware
- Validate mimetype and file extension (`.csv`)
- Parse with `csv-parse/sync`, `columns: true`, `skip_empty_lines: true`, `trim: true`
- Validate required columns present in header (`Plant Name`, `Date`, `Quantity (oz)`)
- For each row:
  1. Validate `Plant Name` not blank → ErrorRow if blank
  2. Validate and parse `Date` (MM/DD/YYYY or MM/DD/YY) → ErrorRow if invalid
  3. Validate `Quantity (oz)` is a positive number → ErrorRow if invalid
  4. Case-insensitive exact match against user's plants → MatchedRow if found
  5. If no exact match → call `findClosestPlant` → UnmatchedRow with suggestion
- Return `{ totalRows, matched, unmatched, errors }`

#### `POST /api/harvests/bulk`
- Validate `rows` is a non-empty array (max 500)
- Validate each row: `plantId`, `harvestedAt`, `quantity` all present and valid
- `Harvest.insertMany()` with all rows, setting `unit: 'oz'` and `userId: req.userId`
- Return `{ imported: N, harvests: [...] }` with 201 status

#### `backend/src/utils/fuzzyMatch.js`
- Exports `findClosestPlant(input, plants, maxDistance = 3)`
- Uses two-row Levenshtein DP (space-efficient)
- Returns `{ plant, distance }` or `null` if no plant within `maxDistance`

#### Date Parsing
- Accept `MM/DD/YYYY` and `MM/DD/YY` only
- Two-digit years → 2000 + YY
- Reject any other format (including ISO `YYYY-MM-DD`)
- Use `Date.UTC` to avoid timezone issues — store as UTC midnight

### Frontend

#### `HarvestImportModal.jsx`
- Step 1: File input (accept `.csv`) + upload button
  - On upload: call `POST /api/harvests/import` via `useMutation`
  - Show loading spinner during upload
- Step 2: Preview table (if `matched.length > 0` or `errors.length > 0`)
  - Matched rows: green rows showing plant emoji, date, quantity
  - Error rows: red rows showing field and reason
- Step 3: Resolution (if `unmatched.length > 0`)
  - `PlantMatchResolver` component for each unmatched row
  - After all resolved: "Confirm import" button enabled
- Step 4: Call `POST /api/harvests/bulk` → show summary toast

#### `PlantMatchResolver.jsx`
- Displays: `"'<rawName>' — did you mean <suggestion> <emoji>?"`
- Two actions: "Yes, use <suggestion>" (accept) | "Choose a different plant" (override)
- Override: `<select>` populated with all available plants sorted alphabetically
- Skip button: "Skip this row" removes it from the bulk payload

#### `Harvests.jsx` additions
- "Download template" link/button → `GET /api/harvests/template`
- "Import CSV" button → opens `HarvestImportModal`

### Tests (`backend/src/__tests__/harvestImport.test.js`)

Required test cases:
1. `GET /api/harvests/template` → 200, CSV with correct headers
2. `POST /api/harvests/import` — valid CSV, all match → 200, matched array populated
3. `POST /api/harvests/import` — plant name case mismatch → matched (case-insensitive)
4. `POST /api/harvests/import` — typo in plant name → unmatched with suggestion
5. `POST /api/harvests/import` — invalid date format → error row
6. `POST /api/harvests/import` — invalid quantity → error row
7. `POST /api/harvests/import` — wrong file type → 400
8. `POST /api/harvests/import` — missing required column → 400
9. `POST /api/harvests/import` — unauthenticated → 401
10. `POST /api/harvests/bulk` — valid payload → 201, harvests created
11. `POST /api/harvests/bulk` — empty rows array → 400
12. `POST /api/harvests/bulk` — unauthenticated → 401
