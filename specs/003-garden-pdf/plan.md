# Implementation Plan: Garden Layout PDF & Shopping List

**Branch**: `003-garden-pdf` | **Date**: 2026-02-23 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/003-garden-pdf/spec.md`

---

## Summary

Adds a two-page printable PDF to the Garden Map view. Page 1 is a visual garden grid (beds at correct positions, plant emojis per cell). Page 2 is a shopping list table (bed name, plant name, cell count, Seed / Starts / Purchased checkboxes). Two buttons are added to the Garden Map header: **Download PDF** (named `.pdf` file via `jsPDF + html2canvas`) and **Print** (`window.print()` with `@media print` CSS). Both owners and helpers can access both buttons. No new backend endpoints are required.

---

## Technical Context

**Language/Version**: JavaScript (React 19 JSX), Node.js 22
**Primary Dependencies**:
- New (frontend): `jspdf` ^2.x + `html2canvas` ^1.x — client-side PDF generation
- Existing: all other deps unchanged
**Storage**: N/A — PDFs are generated on demand, never stored
**Testing**: No new backend route files → no new backend test files required (Constitution VI applies per route file)
**Target Platform**: Browser — Chrome, Firefox, Safari (modern)
**Project Type**: Web application (React 19 + Vite 7 frontend)
**Performance Goals**: PDF generation ≤ 5 seconds from button click (SC-001)
**Constraints**:
- Client-side only generation — no new backend endpoint (spec assumption, confirmed in research)
- Output must fit A4 or US Letter without clipping (FR-008)
- Both owners and helpers can access the feature (FR-011)
**Scale/Scope**: One new component, one modified page, one modified CSS file, one package.json change

---

## Constitution Check

*Evaluated against GardenHive Constitution v1.0.0*

| Principle | Status | Notes |
|---|---|---|
| I. Layered Separation | ✅ PASS | Feature is purely frontend rendering. No business logic moved to frontend. Existing `GET /beds` provides all data. |
| II. REST-First API Design | ✅ PASS | No new endpoints. Existing API consumed as-is. |
| III. Permission-Gated Multi-Tenancy | ✅ PASS | Both owner and helper roles can access Download/Print (FR-011). Buttons are gated by `gardenPermission` check in existing middleware — read access (the only access needed) is already granted to helpers. |
| IV. Schema-Validated Data Integrity | ✅ PASS | No new Mongoose models. Data derived from existing validated data. |
| V. Server State via React Query / UI State via Context | ✅ PASS | Reuses existing `useQuery(['beds'])`. PDF generation state is local `useState` (loading flag). No new queries or contexts. |
| VI. Test-Before-Deploy | ✅ PASS | No new route files → no new backend test coverage required by constitution. Frontend component has no testable HTTP contracts. |
| VII. Simplicity & YAGNI | ✅ PASS | `jsPDF + html2canvas` (~150 KB gzip) is the minimum needed to satisfy FR-001 (named download). No service layer, no feature flags, no backwards-compat shims. |
| VIII. Consistent Naming & Code Style | ✅ PASS | New component: `GardenPrintView.jsx` (PascalCase). Handlers: `handleDownloadPdf`, `handlePrint`. Constants: `PAPER_PRINT_WIDTH_PX`. All follow existing conventions. |

**No complexity violations. No entries in Complexity Tracking table required.**

---

## Project Structure

### Documentation (this feature)

```text
specs/003-garden-pdf/
├── plan.md          ← This file
├── spec.md
├── research.md
├── data-model.md
├── quickstart.md
├── checklists/
│   └── requirements.md
└── tasks.md         ← Generated by /speckit.tasks
```

### Source Code Changes

```text
frontend/
├── package.json                              ← ADD jspdf, html2canvas
├── src/
│   ├── index.css                             ← ADD @media print rules
│   ├── pages/
│   │   └── GardenMap.jsx                     ← ADD buttons + pdf/print handlers + GardenPrintView render
│   └── components/
│       └── GardenPrintView.jsx               ← NEW — print layout component

backend/                                      ← NO CHANGES
```

**Structure Decision**: Single-project web application with `backend/` + `frontend/` split. Feature touches frontend only.

---

## Component Design

### `GardenPrintView.jsx` (new)

A `forwardRef` component that renders both PDF pages as a hidden DOM subtree. Always present in the DOM but positioned off-screen so `html2canvas` can capture it and `@media print` can show it.

**Props**:
```
beds         : Array  — the full beds array from React Query (cells[].plantId populated)
gardenWidth  : Number — feet (from user.gardenWidth)
gardenHeight : Number — feet (from user.gardenHeight)
gardenName   : String — used for page title (from user.gardenName)
```

**Ref**: Points to the outermost `div` (used by html2canvas for capture).

**Sections**:

1. **Page 1 — Garden Map Section** (`data-print-section="1"`)
   - Heading: garden name + date
   - Grid area: positioned `div`s matching the GardenMap grid (same `CELL_PX = 28` constant)
   - Beds with placed positions (`mapRow != null && mapCol != null`)
   - Each bed renders an inner emoji grid (same algorithm as GardenMap.jsx `placedBeds` rendering)
   - SVG dot background (same as GardenMap.jsx)
   - Scale: `transform: scale(var(--print-scale, 1))` — CSS variable set by the parent

2. **Page 2 — Shopping List Section** (`data-print-section="2"`)
   - Heading: "Shopping List"
   - `<table>` with `<thead>`: Bed | Plant | Qty | ☐ Seed | ☐ Starts | ☐ Purchased
   - `<tbody>`: one `<tr>` per `ShoppingListRow` (derived from beds, sorted by bed name then plant name)
   - Empty state: "No plants to list." paragraph when `shoppingRows.length === 0`

**Shopping list derivation** (done inside the component):
```js
// Pseudo-code
const shoppingRows = beds
  .sort((a, b) => a.name.localeCompare(b.name))
  .flatMap(bed => {
    const plantGroups = {};
    bed.cells?.forEach(cell => {
      if (!cell.plantId) return;
      const key = cell.plantId._id;
      if (!plantGroups[key]) plantGroups[key] = { ...cell.plantId, count: 0, bedName: bed.name };
      plantGroups[key].count++;
    });
    return Object.values(plantGroups)
      .filter(p => p.count > 0)
      .sort((a, b) => a.name.localeCompare(b.name));
  });
```

**DOM positioning** (hidden from normal view, visible in print):
```jsx
<div
  ref={ref}
  id="garden-print-view"
  style={{ position: 'fixed', left: '-9999px', top: 0, width: 794, background: 'white' }}
>
```
Using `position: fixed; left: -9999px` (not `display: none`) so:
- `html2canvas` can capture the element (it cannot capture `display: none` elements)
- The browser lays it out for `@media print` correctly

---

### `GardenMap.jsx` (modifications)

**Additions**:
1. Import `useRef` (already imported), `jsPDF` (lazy / dynamic import), `html2canvas` (lazy / dynamic import)
2. `const printViewRef = useRef(null)` — ref for `GardenPrintView`
3. `handleDownloadPdf()` async function — see PDF Download Algorithm below
4. `handlePrint()` function — see Print Algorithm below
5. Two buttons in the page header (visible to both owner and helper — no `isOwner` gate):
   ```jsx
   <div className="flex gap-2">
     <button className="btn-secondary" onClick={handlePrint} disabled={isPdfLoading}>Print</button>
     <button className="btn-secondary" onClick={handleDownloadPdf} disabled={isPdfLoading}>
       {isPdfLoading ? 'Generating…' : 'Download PDF'}
     </button>
   </div>
   ```
6. `<GardenPrintView ref={printViewRef} beds={beds} gardenWidth={gardenWidth} gardenHeight={gardenHeight} gardenName={user?.gardenName} />` rendered at the bottom of the component output (always rendered, never shown in normal view)
7. `const [isPdfLoading, setIsPdfLoading] = useState(false)` — loading state for button feedback

---

## Algorithms

### PDF Download Algorithm (`handleDownloadPdf`)

```
1. setIsPdfLoading(true)
2. Compute: printScale = min(1, 794 / (gardenWidth * 28))
3. Get the section-1 (grid) element: printViewRef.current.querySelector('[data-print-section="1"]')
4. Get the section-2 (table) element: printViewRef.current.querySelector('[data-print-section="2"]')
5. html2canvas(section1, { scale: 2, useCORS: true }) → canvas1
6. html2canvas(section2, { scale: 2, useCORS: true }) → canvas2
7. const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' })
8. Embed canvas1 as PNG on page 1 (scaled to page width, maintaining aspect ratio)
9. pdf.addPage()
10. const PAGE_H = pdf.internal.pageSize.getHeight()
    const PAGE_W = pdf.internal.pageSize.getWidth()
11. If canvas2.height * (PAGE_W / canvas2.width) <= PAGE_H:
      Embed canvas2 as PNG on page 2 (single page)
    Else:
      Tile canvas2 across multiple pages:
        for each page:
          draw the slice of canvas2 at offset y using pdf.addImage() with sy / sh params
          pdf.addPage() (except last)
12. const gardenSlug = (user.gardenName || 'garden').toLowerCase().replace(/\s+/g, '-')
    const dateStr = new Date().toISOString().split('T')[0]
    pdf.save(`${gardenSlug}-${dateStr}.pdf`)
13. setIsPdfLoading(false)
```

**Note on canvas capture ordering**: Section 1 and section 2 are captured sequentially (not in parallel) to avoid simultaneous DOM modifications that could affect layout.

### Print Algorithm (`handlePrint`)

```
1. Compute printScale = min(1, 794 / (gardenWidth * 28))
2. Set CSS variable on the print view: printViewRef.current.style.setProperty('--print-scale', printScale)
3. const original = document.title
4. document.title = `${user.gardenName || 'Garden'} - ${new Date().toISOString().split('T')[0]}`
5. window.print()
6. addEventListener('afterprint', () => { document.title = original }, { once: true })
```

---

## CSS Changes (`index.css`)

Add the following `@media print` block:

```css
@media print {
  /* 1. Show only the print view, hide everything else */
  body > * { display: none !important; }
  #garden-print-view {
    display: block !important;
    position: static !important;
    left: 0 !important;
    width: 100% !important;
  }

  /* 2. Paper setup */
  @page {
    size: A4 landscape;
    margin: 12mm 10mm;
  }
  @page :first {
    margin-top: 15mm;
  }

  /* 3. Reset background/colour */
  html, body { background: white !important; color: black !important; }

  /* 4. Preserve bed background colours */
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* 5. Remove overflow clipping from card wrappers */
  .card { overflow: visible !important; box-shadow: none !important; }

  /* 6. Page break between grid section and shopping list */
  [data-print-section="1"] {
    break-after: page;
    page-break-after: always;
  }

  /* 7. Scale the garden grid to paper width */
  .garden-print-grid {
    transform: scale(var(--print-scale, 1));
    transform-origin: top left;
  }
  .garden-print-grid-wrapper {
    overflow: hidden;
    width: 100%;
  }

  /* 8. Repeating table header */
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }
  tr { break-inside: avoid; page-break-inside: avoid; }

  /* 9. Emoji font stack for print */
  .emoji-cell {
    font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
    font-size: 14px;
  }
}
```

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Install `jspdf` and `html2canvas` in `frontend/`
2. Create `GardenPrintView.jsx` — renders both sections, hidden by default
3. Add `handleDownloadPdf` to `GardenMap.jsx` + render `GardenPrintView`
4. Add Download PDF button to header
5. **STOP AND VALIDATE**: Download PDF from a seeded garden — verify page 1 grid and page 2 shopping list

### Incremental Delivery

1. **US1 only** → Download PDF button works → **Demo: "Download PDF" produces a two-page file**
2. **US2** → Add Print button + `@media print` CSS → **Demo: "Print" opens browser print dialog with correct layout**
3. **Polish** → Verify all edge cases from quickstart.md (empty garden, wide garden, long shopping list, helper access)

---

## Dependencies and Execution Order

```
Install jspdf + html2canvas (package.json)
        │
        ▼
Create GardenPrintView.jsx (new component)
        │
        ▼
Add @media print rules to index.css (parallel with above — different files)
        │
        ▼
Update GardenMap.jsx (depends on GardenPrintView existing)
        │
        ├── Add handleDownloadPdf (US1)
        ├── Add handlePrint (US2)
        └── Render <GardenPrintView> in JSX
                │
                ▼
        Manual validation (quickstart.md)
                │
                ▼
        npm run lint (frontend)
```
