# Implementation Plan: Guest Garden Planner

**Branch**: `004-guest-planner` | **Date**: 2026-02-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-guest-planner/spec.md`

## Summary

Add a public, no-account-required garden bed planner at `/planner`. Guests configure a bed, assign plants from the system library, and download a PDF. A "Sign up to save" flow carries their design into a new account via `sessionStorage`. A secondary CTA on the landing page drives traffic to the planner.

## Technical Context

**Language/Version**: Node.js 22 (backend) / JavaScript + React 19 (frontend)
**Primary Dependencies**: Express 5, Mongoose 9, TanStack React Query 5, React Router 7, Tailwind CSS 3, Lucide React
**Storage**: No new storage — guest state is client-side (`useState` + `sessionStorage` bridge)
**Testing**: Jest 29 + Supertest + mongodb-memory-server (backend)
**Target Platform**: Web (same stack as existing app)
**Project Type**: Web application
**Performance Goals**: Standard — plant library loads in under 1 second
**Constraints**: No persistence of guest data; no user data exposed via public endpoint
**Scale/Scope**: Single new page, one new API endpoint, two modified files

## Constitution Check

| Principle | Status | Notes |
|---|---|---|
| I. Layered Separation | ✅ Pass | Public plants endpoint on backend; no business logic in frontend |
| II. REST-First API Design | ✅ Pass | `GET /api/plants/public` — resource-based, no verb in URL, returns array directly |
| III. Permission-Gated Multi-Tenancy | ✅ Pass | Guest route touches no protected garden data; public plants endpoint has no ownership context |
| IV. Schema-Validated Data Integrity | ✅ Pass | No new models; reading existing validated Plant documents |
| V. Server State via React Query / UI State via Context | ✅ Pass | System plants via `useQuery`; guest bed via `useState`; sessionStorage bridge is one-shot, not state |
| VI. Test-Before-Deploy | ✅ Pass | Backend tests required for `GET /api/plants/public` |
| VII. Simplicity & YAGNI | ✅ Pass | No new models, reuses GardenPrintView and AppLayout; PDF logic duplicated (only 2 uses, not 3) |
| VIII. Consistent Naming & Code Style | ✅ Pass | `GuestPlanner.jsx` (PascalCase page), `usePublicPlants` hook, `gh_guest_bed` sessionStorage key |

## Project Structure

### Documentation (this feature)

```text
specs/004-guest-planner/
├── plan.md              ← this file
├── spec.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── plants-public.md
└── tasks.md             ← generated by /speckit.tasks
```

### Source Code

```text
backend/
└── src/
    ├── routes/
    │   └── plants.js                 ← add GET /public route
    └── __tests__/
        └── plants.test.js            ← add tests for GET /public

frontend/
└── src/
    ├── pages/
    │   ├── GuestPlanner.jsx          ← new page
    │   ├── Landing.jsx               ← add "Try Free Planner" CTA
    │   └── Signup.jsx                ← add sessionStorage carry-over
    ├── components/
    │   └── AppLayout.jsx             ← null-safe user check
    └── App.jsx                       ← add /planner public route
```

**Structure Decision**: Web application (Option 2). All changes within the existing `backend/` + `frontend/` split. No new directories.

## Complexity Tracking

No constitution violations. No complexity justification required.

---

## Phase 0: Research

Complete. See [research.md](research.md).

All decisions resolved:
- Public plants endpoint design confirmed
- PDF reuse approach confirmed
- sessionStorage carry-over approach confirmed
- Routing and layout approach confirmed
- Landing page CTA placement confirmed

## Phase 1: Design & Contracts

Complete. See:
- [data-model.md](data-model.md) — client-side state shape, sessionStorage bridge, data flow
- [contracts/plants-public.md](contracts/plants-public.md) — `GET /api/plants/public` contract
- [quickstart.md](quickstart.md) — manual validation checklist

## Implementation Notes

### Backend: GET /api/plants/public

Add before the first `requireAuth` route in `backend/src/routes/plants.js`:

```js
// GET /api/plants/public — system plants only, no auth required
router.get('/public', async (req, res) => {
  try {
    const plants = await Plant.find({ ownerId: null }).sort({ name: 1 });
    res.json(plants);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});
```

Backend test coverage required (see Constitution Principle VI):
- Returns 200 with system plants — no auth needed
- Returns `[]` when no system plants exist
- Does not return custom plants (`ownerId != null`)
- Returns 200 (not 401) without an Authorization header

### Frontend: GuestPlanner.jsx

Key responsibilities:
1. Bed setup form — name (optional), rows, cols (positive integers, client-side validated)
2. Grid rendering — same cell size as `BedDetail.jsx` (3.5rem × 3.5rem)
3. Plant picker — opens on cell click, lists system plants from `GET /api/plants/public` via `useQuery(['plants', 'public'])`
4. "Not saved" banner — persistent notice that the layout will be lost on exit
5. PDF download — replicated `handleDownloadPdf` from `GardenMap.jsx`; passes guest bed as `[{ ...bed, mapRow: 0, mapCol: 0 }]`, `gardenWidth=bed.cols`, `gardenHeight=bed.rows`, `gardenName=bed.name || 'My Garden Plan'`
6. "Sign up to save" button — writes `gh_guest_bed` to `sessionStorage`, navigates to `/signup`

### Frontend: Signup.jsx carry-over

After successful `POST /api/auth/register` and login:
```js
const saved = sessionStorage.getItem('gh_guest_bed');
if (saved) {
  const bed = JSON.parse(saved);
  const { data: newBed } = await api.post('/api/beds', { name: bed.name, rows: bed.rows, cols: bed.cols });
  if (bed.cells.length > 0) {
    await api.put(`/api/beds/${newBed._id}/cells`, { cells: bed.cells.map(c => ({ row: c.row, col: c.col, plantId: c.plant._id })) });
  }
  sessionStorage.removeItem('gh_guest_bed');
  navigate(`/beds/${newBed._id}`);
} else {
  navigate('/dashboard');
}
```

### Frontend: AppLayout.jsx null-safe check

Identify any places `AppLayout` renders `user.name`, `user.email`, or similar — wrap with `user?.name ?? 'Guest'` or conditionally hide profile UI when `user` is null.

### Frontend: Landing.jsx hero CTA

Add alongside the existing "Start for free" button:
```jsx
<Link to="/planner" className="btn-secondary">Try Free Planner</Link>
```
Use the existing `btn-primary` / outlined button styles to maintain hierarchy.

### Frontend: App.jsx route

```jsx
import GuestPlanner from './pages/GuestPlanner';
// ...
<Route path="/planner" element={<GuestPlanner />} />
```
Place alongside `/login` and `/signup`, outside `<PrivatePage>`.
