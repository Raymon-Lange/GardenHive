# Implementation Plan: UI Regression Test Suite

**Branch**: `005-ui-regression-tests` | **Date**: 2026-02-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/005-ui-regression-tests/spec.md`

## Summary

Add a Playwright E2E regression suite covering 5 user stories (3 P1, 2 P2) across auth, garden bed management, harvest logging, the guest planner, and navigation. Tests run against the local Docker dev stack with a single `npx playwright test` command from the project root. Auth state is managed via `storageState` snapshots; test data is created and torn down via the real API.

## Technical Context

**Language/Version**: Node.js 22 / JavaScript (ESM)
**Primary Dependencies**: Playwright 1.x (`@playwright/test`), existing Docker dev stack
**Storage**: No new storage — tests use the existing dev MongoDB instance via the live API
**Testing**: Playwright test runner (separate from existing Jest backend suite)
**Target Platform**: Chromium (headless), localhost:5173 Docker dev stack
**Performance Goals**: Full suite completes in under 3 minutes
**Constraints**: No backend modifications; no direct DB access from tests; CI integration deferred
**Scale/Scope**: 5 spec files, ~20 test cases, one `playwright.config.js` at project root

## Constitution Check

| Principle | Status | Notes |
|---|---|---|
| I. Layered Separation | ✅ Pass | Tests interact only via HTTP API and browser UI — zero direct DB access |
| II. REST-First API Design | ✅ Pass | No new endpoints; tests consume existing API as documented |
| III. Permission-Gated Multi-Tenancy | ✅ Pass | Auth and permission boundary scenarios covered in auth suite |
| IV. Schema-Validated Data Integrity | ✅ Pass | No new models |
| V. Server State via React Query | ✅ Pass | No frontend state changes |
| VI. Test-Before-Deploy | ✅ Pass | This feature IS the test suite; it strengthens Principle VI |
| VII. Simplicity & YAGNI | ✅ Pass | One config, one fixtures file, five spec files — no unnecessary abstractions |
| VIII. Consistent Naming & Code Style | ✅ Pass | `*.spec.js` files in `tests/e2e/`; fixtures use camelCase; `async`/`await` throughout |

## Project Structure

### Documentation (this feature)

```text
specs/005-ui-regression-tests/
├── plan.md              ← this file
├── spec.md
├── research.md
├── data-model.md
├── quickstart.md
└── tasks.md             ← generated by /speckit.tasks
```

### Source Code

```text
tests/                         ← new top-level directory (declared in CLAUDE.md)
└── e2e/
    ├── .auth/
    │   └── user.json          ← storageState snapshot (gitignored)
    ├── fixtures/
    │   └── index.js           ← isolatedPage + api helpers
    ├── global-setup.js        ← creates fixture user, writes storageState
    ├── global-teardown.js     ← deletes fixture user
    ├── auth.spec.js
    ├── beds.spec.js
    ├── harvests.spec.js
    ├── guest-planner.spec.js
    └── navigation.spec.js

playwright.config.js           ← root level, next to docker-compose.yml
package.json                   ← root level (new; adds @playwright/test dependency)
.gitignore                     ← add tests/e2e/.auth/ and playwright-report/
```

**Structure Decision**: Web application (Option 2 — `backend/` + `frontend/` split). E2E tests placed in `tests/e2e/` at root per the `CLAUDE.md` project structure declaration. `playwright.config.js` at root for discoverability alongside `docker-compose.yml`.

## Implementation Notes

### `playwright.config.js`

```js
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  globalSetup:    './tests/e2e/global-setup.js',
  globalTeardown: './tests/e2e/global-teardown.js',
  use: {
    baseURL: process.env.BASE_URL ?? 'http://localhost:5173',
    storageState: './tests/e2e/.auth/user.json', // default: logged-in fixture user
    trace: 'retain-on-failure',
  },
  reporter: [['list'], ['html', { open: 'never' }]],
  // No webServer — Docker stack is managed externally via ./scripts/start.sh
});
```

### `tests/e2e/global-setup.js`

1. `POST /api/auth/login` with fixture credentials (fixture user is seeded by backend seed script)
2. Open a blank page at `http://localhost:5173`
3. `page.evaluate` → inject `gh_token` + `gh_user` into `localStorage`
4. `page.context().storageState({ path: 'tests/e2e/.auth/user.json' })`

If the fixture user does not exist yet, `global-setup.js` registers them first via `POST /api/auth/register`.

### `tests/e2e/fixtures/index.js` — `isolatedPage` fixture

Extends `@playwright/test`'s base `test`:
- **Setup**: `POST /api/auth/register` with `e2e-${Date.now()}-${random}@test.local` → inject token → yield `page`
- **Teardown**: `DELETE /api/auth/me` with the test user's token

Used in `beds.spec.js` and `harvests.spec.js` where each test mutates data.

### Auth spec (`auth.spec.js`)

Uses **unauthenticated** browser (`browser.newContext()` — no storageState) for all cases except the logout test (which starts from the shared fixture storageState).

### Beds spec (`beds.spec.js`)

Uses `isolatedPage` fixture. Garden dimensions setup is required before bed creation — the test sets garden width/height via the profile API (`PUT /api/auth/me`) before navigating to Garden Map.

PDF download test pattern:
```js
const [download] = await Promise.all([
  page.waitForEvent('download'),
  page.getByRole('button', { name: 'Download PDF' }).click(),
]);
expect(download.suggestedFilename()).toMatch(/\.pdf$/);
const buffer = await fs.readFile(await download.path());
expect(buffer.slice(0, 4).toString()).toBe('%PDF');
```

### Guest Planner spec (`guest-planner.spec.js`)

Uses `browser.newContext()` with **no storageState** to guarantee unauthenticated state. The sign-up carry-over test registers a fresh account; the test user is torn down via `DELETE /api/auth/me` in an `afterEach`.

### Navigation spec (`navigation.spec.js`)

Uses the shared fixture storageState (default). Mobile viewport test uses `page.setViewportSize({ width: 375, height: 812 })`.

## Complexity Tracking

No constitution violations. No complexity justification required.

---

## Phase 0: Research

Complete. See [research.md](research.md).

All decisions resolved:
- Framework: Playwright (download detection decisive factor)
- Auth: `storageState` + per-test isolated user fixture
- Test data: API-based creation via `request.newContext()`
- Structure: `tests/e2e/` at root, `playwright.config.js` at root
- webServer: none (Docker stack external)

## Phase 1: Design & Contracts

Complete. See:
- [data-model.md](data-model.md) — test data shapes, auth state file format, data flow
- [quickstart.md](quickstart.md) — run commands, per-suite manual validation checklist
